import { STYLES, featureFor, latLng, getJSON } from './_utils.js';
import _sessionTpl from './_session.rv.pug';

/* global fetch, ol */

// mount OL3 canvas
const mapLayer = new ol.layer.Tile();

const map = new ol.Map({
  controls: [],
  layers: [mapLayer],
  target: document.getElementById('map'),
  view: new ol.View({
    center: latLng([-102.38705181291395, 23.572312362011846]),
    zoom: 16,
    minZoom: 5,
  }),
});

// TODO: change this dinamically!
mapLayer.setSource(new ol.source.OSM());

// mount vectors' canvas
const vectorSource = new ol.source.Vector();
const vectorLayer = new ol.layer.Vector({
  source: vectorSource,
  style: feature => STYLES[feature.getGeometry().getType()],
});

map.addLayer(vectorLayer);

function addLayer(result) {
  // vectorSource.clear();
  vectorSource.addFeatures(featureFor(result));
  // vectorSource.addFeatures((new ol.format.GeoJSON())
  //   .readFeatures(result, { featureProjection: 'EPSG:3857' }));
}

addLayer({"type":"Feature","geometry":{"type":"MultiPolygon","coordinates":[[[[-104.59242248550913,19.14794158903328],[-104.67590332068153,19.177358627199055],[-104.80584716801224,19.25166320829061],[-104.8990325927798,19.285137176339788],[-104.95168304403711,19.31527709945874],[-104.98361206044808,19.33944320663886],[-105.02250671371371,19.371944427493474],[-105.07861328117781,19.49527740522825],[-105.0991744991037,19.55819320665131],[-105.11765289346613,19.581525802374017],[-105.16972351043154,19.606941223458875],[-105.209175110243,19.62027549751639],[-105.26833343533963,19.677915572745633],[-105.30285644546842,19.72506713823799],[-105.31848144566203,19.758470535586923],[-105.32931518534735,19.778469085480083],[-105.38694763162778,19.849998473850633],[-105.4145812988877,19.879581451323077],[-105.43764495864775,19.899232864705084],[-105.45694732625793,19.922222137042127],[-105.49778747571128,19.991107940379322],[-105.51528930705575,20.021663665945596],[-105.52778625473172,20.04388809186213],[-105.54640197736921,20.0909709932169],[-105.59557342557298,20.243331909340327],[-105.66223144542471,20.349720001377136],[-105.67833709727904,20.383054733689164],[-105.67536163363235,20.424163818205784],[-105.62001037617779,20.462221145989247],[-105.59487152090384,20.47569274922114],[-105.55139923118941,20.491247176915863],[-105.49667358441826,20.494163512835996],[-105.45056152369523,20.49152565018875],[-105.33535766632309,20.51916503893557],[-105.24472808873014,20.574649810640437],[-105.23507690447542,20.63090133622785],[-105.26388549821701,20.69666481033289],[-105.26689147945808,20.699043274327835],[-105.21250915517322,20.77388763390735],[-105.20028686494669,20.79083251960526],[-105.1641693118641,20.841388702526785],[-105.14889526400509,20.865831375517757],[-105.13389587359552,20.88319206276367],[-105.08931732153701,20.92055511482687],[-105.06181335450253,20.934997558690554],[-105.03979492189796,20.93423271137067],[-105.0102767945383,20.926387786667192],[-104.96410369862662,20.923677444058967],[-104.91571044907784,20.937358856426272],[-104.88021087683035,20.956455230724487],[-104.85611724871188,20.980552673767022],[-104.82847595250308,21.002637863047084],[-104.79264831566707,21.019441604646488],[-104.7699966434302,21.02055358847747],[-104.72194671636771,21.012775421348806],[-104.4838943478457,20.848468780809753],[-104.47055053737722,20.83346939129956],[-104.33862304731565,20.742496490320946],[-104.28354644731053,20.71645545945205],[-104.28236389187998,20.74930381771719],[-104.2825088500033,20.808748245035645],[-104.27708435076204,20.8516654965656],[-104.25889587444487,20.894094467485843],[-104.21049499504784,20.976873397989095],[-104.2038955684256,21.047359466666194],[-104.21139526408001,21.113609313918857],[-104.14916992165439,21.184165954195578],[-104.12500000044952,21.187496185101054],[-104.06767272921292,21.201858520954147],[-104.0425109861929,21.211387633932304],[-103.96730041548165,21.28096961955248],[-103.95584106421359,21.359722137766596],[-103.99501037582803,21.3952751162538],[-104.09221649139783,21.459163665770745],[-104.1640319819902,21.504858016584365],[-104.18917846711241,21.523330688560577],[-104.2052154539299,21.547357559104228],[-104.13612365728079,21.689720153562405],[-104.09431457555706,21.783956527871624],[-104.2019500731372,21.90305328328259],[-104.26972961413026,21.97138595589729],[-104.31375885039046,22.00388717675196],[-104.33805847182089,22.0199966426311],[-104.35473632811892,22.032497406130574],[-104.38278198200271,22.054996490395865],[-104.3984832761821,22.070831298825567],[-104.32964324923643,22.26453781127111],[-104.29611206092272,22.283885956172128],[-104.26222229042622,22.29944229132883],[-104.24195861859522,22.30722045935687],[-104.14958953812652,22.340553283307543],[-104.12055969227583,22.3461074827743],[-104.09889221200581,22.344718933132413],[-104.04112243655106,22.348331451335582],[-104.0138931278654,22.35180473290228],[-103.9502868656462,22.36805343631721],[-103.92167663536827,22.510829925760618],[-103.9424972537451,22.52527618364911],[-104.02944946302216,22.581943511683903],[-103.9976348880395,22.65027427683657],[-104.00334167457845,22.729999542245253],[-104.00695800770575,22.764720916737076],[-103.9747314451999,22.759162903245567],[-103.80196380658424,22.723052978212536],[-103.77181243869296,22.63541412396279],[-103.8063964840104,22.610275268688838],[-103.82472229040121,22.600276947023644],[-103.86680603047375,22.579582213948186],[-103.88390350324391,22.4611091617586],[-103.86653900107387,22.188192367184172],[-103.8416671751998,22.243610382213546],[-103.83194732680755,22.27111053432384],[-103.79194641119778,22.39472198443218],[-103.77056884807371,22.486110686958796],[-103.73527526823887,22.577219009649752],[-103.7086181639969,22.57749938948541],[-103.65639495816066,22.572080612630316],[-103.61583709690433,22.527219772374735],[-103.62479400633816,22.49555206297748],[-103.64249420204561,22.451942444088672],[-103.65167236358855,22.419998168880568],[-103.66388702396682,22.37221908614208],[-103.6838989260944,22.287080764465884],[-103.7008972171327,22.14599227912055],[-103.68126678493405,22.114402771171115],[-103.64895629859416,22.083887100509457],[-103.60305786103129,22.08583068833576],[-103.58250427205434,22.08930396990246],[-103.4833297725508,22.141664504913138],[-103.4697265625307,22.161663055705617],[-103.39389038113603,22.283607482899185],[-103.3799972530706,22.306388855361547],[-103.37167358416843,22.327499389985007],[-103.36833953833889,22.353748321627904],[-103.371536254994,22.382497787642933],[-103.3832092285229,22.412845611535886],[-103.40493774398158,22.433748245385402],[-103.37251281711269,22.505832671940425],[-103.17945861802065,22.36861038196372],[-103.05375671360133,22.28110885598909],[-103.05375671360133,22.260553359550045],[-103.10611724861201,22.11388778699194],[-103.1511230469909,21.99888610800764],[-103.16722106899698,21.978748321478008],[-103.22084045432337,21.96305465714687],[-103.24333953858871,21.968053817529835],[-103.29306030259073,21.982498168855557],[-103.39418029828198,21.93333053557592],[-103.52223205566469,21.79527664160389],[-103.51918029803215,21.7494430541538],[-103.50930786166833,21.72888565025272],[-103.51556396490491,21.59069252054354],[-103.6502838130474,21.461387634332027],[-103.70390319837378,21.404998779570178],[-103.73306274444997,21.290554046232387],[-103.69249725334544,21.236942291653577],[-103.60751342800216,21.208610534648642],[-103.53945922866035,21.19638824442211],[-103.0558471679123,21.054443358974027],[-103.05903625471922,21.075277328685956],[-103.06584167465343,21.10110855131876],[-103.08097839333806,21.14027595547111],[-103.08556365963506,21.187496185101054],[-103.08014678934268,21.231388092186876],[-103.06945800778067,21.261665344480207],[-103.05307006862864,21.289165496590556],[-103.02875518840108,21.307775497741204],[-103.00486755359458,21.29916381825575],[-102.97611236609265,21.2848587035665],[-102.82819366470574,21.32208061243051],[-102.76222228982664,21.344997405705897],[-102.68930816673833,21.3804149624807],[-102.66972351093114,21.423610687283542],[-102.6611175538319,21.444999695179945],[-102.64611816432165,21.497219086092116],[-102.63917541521312,21.528329848943542],[-102.64042663568057,21.549165726117508],[-102.65819549552555,21.56555366526959],[-102.70694732635786,21.583885193147296],[-102.74362182598634,21.599998473950563],[-102.76646423363735,21.615552902544607],[-102.77416992170436,21.642913818018428],[-102.77347564688347,21.67110824584904],[-102.7644500733121,21.696386336860144],[-102.741386413552,21.724166869705414],[-102.71556091330535,21.74853897109682],[-102.68153381363442,21.763608932206637],[-102.64389038083624,21.763122558159694],[-102.61569976792981,21.75458145117318],[-102.58889770466521,21.73666381828076],[-102.56861877403702,21.7205543515023],[-102.54000854465846,21.704441070699033],[-102.51306152327055,21.693332671765575],[-102.48972320516162,21.686527251831365],[-102.43917846701248,21.677219390962307],[-102.31417846636299,21.65916442889545],[-102.27541351332286,21.65374755860313],[-102.24597930889786,21.654441833424016],[-102.22112274182092,21.664443970013394],[-102.20278930648118,21.674442291678588],[-102.18583679183433,21.685554504636855],[-102.14916992205411,21.71277618437358],[-102.08708953865113,21.76527595512141],[-101.95500183076973,21.894443512158546],[-101.88863372806395,21.965553284056966],[-101.87139892611941,21.98416519177033],[-101.84620666460575,22.011760711587726],[-101.83681488080197,22.018053054804795],[-101.8084869387211,22.01860809298927],[-101.77166748007,21.99888610800764],[-101.54223632834373,21.864440918213973],[-101.52485656737656,21.856639862439863],[-101.58277893080287,21.797636031877516],[-101.58681488040224,21.767776489493542],[-101.56681060812292,21.72972106917217],[-101.5541763303732,21.708053588902146],[-101.5447311403297,21.684165954994967],[-101.54320526151344,21.660415649362903],[-101.54945373580114,21.640274047909145],[-101.56666564910029,21.613609313818927],[-101.58251190230231,21.592914581642788],[-101.6105728149833,21.571109771299064],[-101.62639617953988,21.55083274813296],[-101.63195800795557,21.530277252593294],[-101.62847900400266,21.509719848692214],[-101.58168029740767,21.394996642980857],[-101.57125854524554,21.36478996318641],[-101.57501220664784,21.332775116378684],[-101.59292602551551,21.30291557309539],[-101.631118774112,21.26555252103219],[-101.65222930873546,21.247636794702487],[-101.75222778328543,21.18861007729339],[-101.80847930887285,21.15999794045274],[-102.01834106448837,20.903888702401844],[-102.0552825926174,20.845554351452336],[-102.07472229030128,20.813888549517117],[-102.0902862553063,20.778608321916693],[-102.0782012942542,20.746803283345002],[-102.052650451457,20.712915420310537],[-102.03916931181413,20.695274353228967],[-101.97986602769487,20.5930538175798],[-101.9913864132522,20.567775726568698],[-102.0269470215876,20.531665802434986],[-102.04903411832976,20.514581680100605],[-102.07668304438681,20.481109619513518],[-102.09292602541558,20.457220077244926],[-102.10403442344972,20.427358627398917],[-102.10890197794379,20.394165039185395],[-102.10881042516087,20.389083862430482],[-102.17223358181423,20.358608245774064],[-102.19084167460346,20.349720001377136],[-102.21764373786806,20.342357635796418],[-102.26187896744023,20.345344543316173],[-102.29778289826197,20.35756874100474],[-102.39750671356381,20.346942901194097],[-102.44361877428685,20.338054656797112],[-102.49111938465171,20.316387176527144],[-102.58119201659815,20.268539428751808],[-102.61597442627863,20.233470916849512],[-102.64638519282227,20.22291374207572],[-102.6783370969793,20.21722030597249],[-102.75389099107622,20.2052764890189],[-102.93860626246891,20.149166107529993],[-102.95777893075291,20.140830993855445],[-103.05291748065707,20.08916473366571],[-103.08027648956818,20.059164047183174],[-103.09084320075294,20.04055213946981],[-103.09653472939408,20.009233474945063],[-103.03653717045393,19.910415649262973],[-103.01111602788222,19.898122787436876],[-102.98487091026414,19.90347099269235],[-102.95611572276226,19.923887252494865],[-102.92900085460559,19.952453612944055],[-102.73334503194752,19.880970000964965],[-102.72473144500003,19.82277488665187],[-102.73986053473573,19.806524276674168],[-102.77667236353858,19.783885955772405],[-102.8219680781641,19.761299133648265],[-102.82945251502139,19.734722137416895],[-102.82024383588418,19.70277976967077],[-102.80139160144108,19.675693511646386],[-102.76556396460512,19.599998474350286],[-102.7552795407181,19.555274963269085],[-102.7511062619443,19.52402687034396],[-102.74302673379657,19.472879410156793],[-102.71083831783397,19.467775344756546],[-102.67916870097463,19.473331451685283],[-102.65292358425586,19.480970383076908],[-102.60701751684479,19.486560821624778],[-102.57236480738982,19.40305519124422],[-102.591667175,19.360553741262322],[-102.64028930650613,19.277496337486127],[-102.6800079348182,19.230066299620205],[-102.69931793227659,19.2498588562014],[-102.7233428953582,19.256526946961174],[-102.76757812493037,19.254718780847213],[-102.86917114243414,19.22083282437552],[-102.89418029748259,19.21166610760497],[-102.96209716765003,19.1791648867503],[-102.98242950451788,19.158678054448842],[-102.96749877914522,19.127080917550472],[-102.97417449975319,19.09902572635633],[-102.99890136750395,19.070274352879267],[-103.1436843874244,18.95895576459702],[-103.18459320101528,18.98458290137995],[-103.20278930628132,18.998886108607167],[-103.23284912138968,19.028818130052798],[-103.25334167517804,19.047496795340976],[-103.27972412107118,19.06506729082298],[-103.30972290009163,19.033332824750232],[-103.34542846655035,18.98235893281867],[-103.40986633276492,18.976108551068933],[-103.45958709676694,18.974651336390252],[-103.47955322250306,18.967220306672004],[-103.50140380833892,19.046943664618595],[-103.50167846668774,19.15999984741518],[-103.49501800577622,19.190135955610003],[-103.49111175550297,19.30916404688344],[-103.64418029778238,19.480274200793872],[-103.72638702384194,19.437496185001123],[-103.76459503213488,19.4163875578397],[-103.789176940863,19.398887633957315],[-103.81472015381189,19.392358779834012],[-103.84486389185497,19.39735794111624],[-103.91779327374041,19.432220458807308],[-104.00140380823899,19.474163055680663],[-104.0233383179089,19.485416412737436],[-104.04833984400847,19.500553131422066],[-104.06777954079303,19.51694107057409],[-104.14666748071949,19.463886260742527],[-104.1291809081722,19.383052825527614],[-104.19223022474495,19.34555435175207],[-104.23082733191569,19.32722091641233],[-104.31973266632934,19.286109924433617],[-104.39118194579004,19.271318435697424],[-104.459167480095,19.265552520532538],[-104.53846740754466,19.25402450602627],[-104.59174346948538,19.172916412462655],[-104.59242248550913,19.14794158903328]]]]}});

// mount Ractive app
const app = new Ractive({
  el: document.getElementById('menu'),
  template: _sessionTpl,
  data() {
    // initial state
    return {
      isEdited: null,
      features: [],
    };
  },
});

// mocked data -- update with API
const data = [
    {
        "cluster_id": "14659",
        "edited": false,
        "features": [
            {
                "geoserver_id": 147231,
                "postgres_id": "7287_1349926_32"
            },
            {
                "geoserver_id": 147230,
                "postgres_id": "7226_1349926_32"
            },
            {
                "geoserver_id": 147229,
                "postgres_id": "7070_1349926_32"
            },
            {
                "geoserver_id": 147228,
                "postgres_id": "7033_1349926_32"
            },
            {
                "geoserver_id": 147227,
                "postgres_id": "6982_1349926_32"
            },
            {
                "geoserver_id": 147226,
                "postgres_id": "6937_1349926_32"
            },
            {
                "geoserver_id": 147225,
                "postgres_id": "6924_1349926_32"
            },
            {
                "geoserver_id": 147224,
                "postgres_id": "6739_1349926_32"
            },
            {
                "geoserver_id": 147223,
                "postgres_id": "6999_1349926_32"
            }
        ]
    }
];

app.set('isEdited', data[0].edited);
app.set('features', data[0].features);

const featureIds = data[0].features.map(f => f.geoserver_id).join(',');

getJSON(`/layers?features=${featureIds}`)
  .then(result => {
    result.features.forEach(addLayer);

    // el centro se puede calcular promediando todos los puntos (o sea lo puedo calcular,
    // pero por ahorita tu tienes los puntos)
    // suma todas las entreadas de longitud y dividelas entre el numero todal y luego
    // lo mismo con latitud

    const centroidsByFeature = result.features.map(calculateCentroidFeature);

    const centroidByCluster = calculateCentroid(centroidsByFeature);


    //const coords = result.features[0].geometry.coordinates[0][0];
    map.getView().setCenter(latLng(centroidByCluster));
    // TODO: how?
    console.log(centroidByCluster);
  })


function calculateCentroidFeature(feature) {
  return calculateCentroid(feature.geometry.coordinates[0][0]);
}

function calculateCentroid(coords) {
  var longitude = 0;
  var latitude = 0;
  for(var i=0; i < coords.length; i++) {
    longitude += coords[i][0];
    latitude += coords[i][1];
  }
  return [longitude / coords.length, latitude / coords.length];
}
